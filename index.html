<!doctype html>



  


<html class="theme-next muse use-motion" lang="default">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Jngoogle">
<meta property="og:url" content="https://jngoogle.github.io/index.html">
<meta property="og:site_name" content="Jngoogle">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jngoogle">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://jngoogle.github.io/"/>





  <title> Jngoogle </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Jngoogle</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">interesting</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://jngoogle.github.io/2017/07/10/开发RecyclerViewAdapter简化日常开发/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Jngoogle">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jngoogle">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jngoogle" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/10/开发RecyclerViewAdapter简化日常开发/" itemprop="url">
                  通用的RecyclerViewAdapter开发
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-10T11:31:11+08:00">
                2017-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>日常开发中经常会使用到的重复性的工作应当让它简单化、流程化、自动化。</p>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>想要开发实现通用的 RecyclerViewAdapter 我们先要了解官方的 Adapter 是如何使用的，然后在此基础上进行抽象。下面我们就先来看一下官方的 Adapter 的使用范例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NormalRecyclerViewAdapter</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">Adapter</span>&lt;<span class="title">NormalRecyclerViewAdapter</span>.<span class="title">NormalTextViewHolder</span>&gt; </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> LayoutInflater mLayoutInflater;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Context mContext;</div><div class="line"><span class="keyword">private</span> String[] mTitles;</div><div class="line"></div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">NormalRecyclerViewAdapter</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    mTitles = context.getResources().getStringArray(R.array.titles);</div><div class="line">    mContext = context;</div><div class="line">    mLayoutInflater = LayoutInflater.from(context);</div><div class="line">&#125;</div><div class="line"></div><div class="line">  </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> NormalTextViewHolder <span class="title">onCreateViewHolder</span><span class="params">(ViewGroup parent, <span class="keyword">int</span> viewType)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NormalTextViewHolder(mLayoutInflater.inflate(R.layout.item_text, parent, <span class="keyword">false</span>));</div><div class="line">&#125;</div><div class="line">  </div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(NormalTextViewHolder holder, <span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">    holder.mTextView.setText(mTitles[position]);</div><div class="line">&#125;</div><div class="line"></div><div class="line">  </div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getItemCount</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mTitles == <span class="keyword">null</span> ? <span class="number">0</span> : mTitles.length;</div><div class="line">&#125;</div><div class="line"></div><div class="line">  </div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NormalTextViewHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> </span>&#123;</div><div class="line">    <span class="meta">@InjectView</span>(R.id.text_view)</div><div class="line">    TextView mTextView;</div><div class="line"></div><div class="line">    NormalTextViewHolder(View view) &#123;</div><div class="line">        <span class="keyword">super</span>(view);</div><div class="line">        ButterKnife.inject(<span class="keyword">this</span>, view);</div><div class="line">        view.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                Log.d(<span class="string">"NormalTextViewHolder"</span>, <span class="string">"onClick--&gt; position = "</span> + getPosition());</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>我们来归纳一下 adapter 使用的几个重要的点。</p>
<p>1.使用 RecyclerViewAdapter 需要重写三个方法<code>onCreateViewHolder()</code>     <code>onBindViewHolder()</code>    <code>getItemCount()</code> 。</p>
<p>2.需要自己实现 ViewHolder ，用来绑定 itemView  中的视图与数据.</p>
</blockquote>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h3 id="实现三个重写方法"><a href="#实现三个重写方法" class="headerlink" title="实现三个重写方法"></a>实现三个重写方法</h3><p>首先我们来看第一个重写的方法 onCreateViewHolder()</p>
<p>该方法作用是创建 ViewHolder 使得 itemView 与对应的数据进行绑定，那我们就需要先来创建自己的 ViewHolder。</p>
<h4 id="step1-创建自定义-ViewHolder"><a href="#step1-创建自定义-ViewHolder" class="headerlink" title="step1 创建自定义 ViewHolder"></a>step1 创建自定义 ViewHolder</h4><p>我们先理一下 viewholder 中代码的逻辑。</p>
<p><br></p>
<p>首先我们在 viewholder 中创建了 itemView 中所需要的各个 view 并初始化它们。接着我们给这个 view 设置了点击事件。</p>
<p><br></p>
<p>我们开发一个通用的 viewholder 来完成上面的工作。需要先创建 itemView 中的各个 view 然后初始化它们。在事先不知道view类型的情况下，要在运行时获得view 的类型并初始化，我们使用泛型的方式来实现，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T extends View&gt; <span class="function">T <span class="title">getView</span><span class="params">(<span class="keyword">int</span> resId)</span> </span>&#123;</div><div class="line">            View childView = itemView.findViewById(resId);</div><div class="line">            <span class="keyword">return</span> (T) childView;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>其中的 itemview 是在 viewholder 的构造方法中需要传入的列表项布局的参数。这样通过 resId  ，我们可以得到这个 itemView  中任何一个子 view 了。在这里我们同时也把这个子 view 初始化完毕了。</p>
<p><br></p>
<p>接下来我们给里面的子 view 都添加上点击事件。模仿官方的用法，我们同样在 viewholder 中实现 点击事件的监听（以下是完整的 viewholder  代码）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyViewHolder</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ViewHolder</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">private</span> Context context = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="title">MyViewHolder</span><span class="params">(Context context, View itemView)</span> </span>&#123;</div><div class="line">           <span class="keyword">super</span>(itemView);</div><div class="line">           <span class="keyword">this</span>.context = context;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">public</span> &lt;T extends View&gt; <span class="function">T <span class="title">getView</span><span class="params">(<span class="keyword">int</span> resId)</span> </span>&#123;</div><div class="line">           View childView = itemView.findViewById(resId);</div><div class="line">           <span class="keyword">return</span> (T) childView;</div><div class="line">       &#125;</div><div class="line">  </div><div class="line">       <span class="function"><span class="keyword">public</span> MyViewHolder <span class="title">setText</span><span class="params">(<span class="keyword">int</span> resId, String text)</span> </span>&#123;</div><div class="line">           TextView textView = getView(resId);</div><div class="line">           textView.setText(text);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">public</span> MyViewHolder <span class="title">setTextColor</span><span class="params">(<span class="keyword">int</span> resId, <span class="keyword">int</span> colorId)</span> </span>&#123;</div><div class="line">           TextView textView = getView(resId);</div><div class="line">           textView.setTextColor(colorId);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">public</span> MyViewHolder <span class="title">setImageResource</span><span class="params">(<span class="keyword">int</span> viewId, <span class="keyword">int</span> drawableId)</span> </span>&#123;</div><div class="line">           ImageView imageView = getView(viewId);</div><div class="line">           imageView.setImageResource(drawableId);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">public</span> MyViewHolder <span class="title">setImageBitmap</span><span class="params">(<span class="keyword">int</span> viewId, Bitmap bm)</span> </span>&#123;</div><div class="line">           ImageView view = getView(viewId);</div><div class="line">           view.setImageBitmap(bm);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">           <span class="keyword">if</span> (iOnItemClickListener != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="comment">// 此处需要注意如何获取 itemView 的位置</span></div><div class="line">               iOnItemClickListener.onClick(itemView, <span class="keyword">this</span>.getAdapterPosition());</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IOnItemClickListener</span> </span>&#123;</div><div class="line">       <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view, <span class="keyword">int</span> position)</span></span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这里我们在 onClick()  这个点击事件的方法中不要实现具体的点击逻辑，抽象成一个接口留给实现类去实现。这里我们在 onClick()  中是调用了 iOnItemClickListener 接口的 onClick()  方法。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://jngoogle.github.io/2017/07/01/双重检查锁定以及IoDH探究/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Jngoogle">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jngoogle">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jngoogle" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/01/双重检查锁定以及IoDH探究/" itemprop="url">
                  双重检查锁定以及IoDH探究
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-01T14:36:08+08:00">
                2017-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在上一篇中《创建型模式之单例模式》中提到的双重检查锁定以及 IoDH 这两种方式我们有必要好好的去深入探究一下。</p>
<p><br></p>
<h3 id="双重检查锁定中的-volatile"><a href="#双重检查锁定中的-volatile" class="headerlink" title="双重检查锁定中的 volatile"></a>双重检查锁定中的 volatile</h3><p>为什么在双重检查锁定中需要使用 volatile 这个关键字？我们先来看看下面代码的问题就能明白它的作用了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleInstance</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> SingleInstance sInstance = <span class="keyword">null</span>;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">SingleInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleInstance <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> == sInstance) &#123;</div><div class="line">          <span class="keyword">synchronized</span> (SingleInstance.class) &#123;</div><div class="line">              <span class="keyword">if</span> (<span class="keyword">null</span> == sInstance) &#123;</div><div class="line">                  sInstance = <span class="keyword">new</span> SingleInstance();<span class="comment">//问题在这里出现</span></div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> sInstance;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是一段没有使用 volatile 的代码块。我们来看看如果没有使用 volatile 的双重检查锁定会出现什么问题。</p>
<blockquote>
<p>假设现在有线程 A  和  B，同时要调用上面的代码块。</p>
<p>现在假设 A 线程先调用了上面的代码获得线程锁 synchronized。B 线程则停留在外层的 <code>null ==sInstance</code>  判断处，去检查有没有实例，如果 A 线程已经创建好了实例此时 B 线程直接返回该实例即可；若没有实例则 B 获取线程锁创建一个实例。</p>
</blockquote>
<p>看起来上面的逻辑很正常没有问题，但是实际情况是：在 A 线程创建实例的时候，也就是我们代码的第10行，真正创建实例的过程可能并不是我们所想当然的那么简单。</p>
<p><br></p>
<p>在 new 一个实例的时候在 A  线程中经历了如下的操作：</p>
<ol>
<li>分配内存空间</li>
<li>初始化对象</li>
<li>设置对象指向分配的内存空间地址</li>
</ol>
<p>但是实际情况确实，在上面的三个步骤中其实第二步与第三步是可能对调顺序的。也就是说可能执行的顺序是132，这样的顺序。<em>你可以参考  <a href="https://www.ibm.com/developerworks/java/library/j-dcl/index.html" target="_blank" rel="external">Double-checked locking and the Singleton pattern</a> 中 Out-of-order writes 的部分。</em></p>
<blockquote>
<p>根据 java 语言规范，所有线程在执行java程序时必须要遵守 intra-thread semantics。intra-thread semantics保证重排序不会改变单线程内的程序执行结果。换句话来说，intra-thread semantics允许那些在单线程内，不会改变单线程程序执行结果的重排序。上面三行伪代码的2和3之间虽然被重排序了，但这个重排序并不会违反intra-thread semantics。这个重排序在没有改变单线程程序的执行结果的前提下，可以提高程序的执行性能。</p>
</blockquote>
<p><br></p>
<p><strong>如果顺序变成了132会导致什么结果呢？</strong></p>
<p><br></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://jngoogle.github.io/2017/06/29/创建型模式之单例模式/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Jngoogle">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jngoogle">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jngoogle" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/29/创建型模式之单例模式/" itemprop="url">
                  创建型模式之单例模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-29T21:15:11+08:00">
                2017-06-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/设计模式/" itemprop="url" rel="index">
                    <span itemprop="name">设计模式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<p>ps: 本文较长，请分段阅读</p>
</blockquote>
<p><img src="http://imglf1.nosdn.127.net/img/R3RmT3FSa2l4djRyQmgrU2R2VUpwN0Z2ME9OZUlEdnZGMkN4bFhwYVBDdlpveitaYXZUZ21BPT0.png?imageView&amp;thumbnail=1680x0&amp;quality=96&amp;stripmeta=0&amp;type=jpg%7Cwatermark&amp;type=2&amp;text=wqkg5ZOO5ZGm5LiN6ZSZ5ZOfIC8gamFtbWljbmljb29sZS5sb2Z0ZXIuY29t&amp;font=bXN5aA==&amp;gravity=southwest&amp;dissolve=30&amp;fontsize=240&amp;dx=8&amp;dy=10&amp;stripmeta=0" alt="设计模式结构图"></p>
<p>上图列举出来所有设计模式的结构图，这次就来看看单例模式。</p>
<p>在软件设计中，许多地方用到的实例是不需要创建多个实例，例如在 Windows 系统中有且仅有一个任务管理器（<em>它也确实不需要多个，并且如果有多个将出现很多问题</em>）。不管是实际情况的需要还是为了提高性能，当我们只需要一个实例的时候就可以使用单例模式来设计。</p>
<p>我们就从日常开发中使用最多的 单例模式 开始我们的设计模式学习。</p>
<h3 id="单例模式的定义"><a href="#单例模式的定义" class="headerlink" title="单例模式的定义"></a>单例模式的定义</h3><p>单例模式的定义是：<strong>确保某一个类只有一个实例，并自行实例化且向整个系统提供这个实例</strong>。</p>
<ul>
<li>只有一个实例</li>
<li>必须是自行实例化</li>
<li>提供全局访问的方法</li>
</ul>
<h3 id="如何实现单例模式"><a href="#如何实现单例模式" class="headerlink" title="如何实现单例模式"></a>如何实现单例模式</h3><h4 id="第1步"><a href="#第1步" class="headerlink" title="第1步"></a>第1步</h4><p>创建一个类假设是 SingleInstance，然后保证它的构造方法（<em>无参数</em>）的访问权限是 private ，避免外部类使用 new 创建多个实例（此时外部类无法使用 new 来创建该单例）。</p>
<h4 id="第2步"><a href="#第2步" class="headerlink" title="第2步"></a>第2步</h4><p>创建 SingleInstance中的成员变量假设是 sInstance（<em>类型是 SingleInstance</em>） ，使用 private 和 static 进行修饰即私有的静态变量，保证其是该 单例的唯一实例。</p>
<h4 id="第3步"><a href="#第3步" class="headerlink" title="第3步"></a>第3步</h4><p>在 SingleInstance类中创建一个 public 修饰的公共方法 getInstance ，提供给外部类调用该方法来引用这个单例。</p>
<h3 id="具体实现方式"><a href="#具体实现方式" class="headerlink" title="具体实现方式"></a>具体实现方式</h3><p>实现单例模式有几种不同的方法，下面逐一来看看这几种使用单例的方式。</p>
<h4 id="饿汉式"><a href="#饿汉式" class="headerlink" title="#饿汉式"></a>#饿汉式</h4><p><strong>方法特点：</strong> 直接在类中 new 出成员变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleInstance</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> SingleInstance sInstance = <span class="keyword">new</span> SingleInstance();</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">SingleInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleInstance <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> sInstance;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这种实现方式由于直接 new 出了成员变量，所以在类被加载的时候同时就会创建该单例。在 getInstance 方法中就可以直接返回 sInstance 这个单例。</p>
<p><strong>需要注意的是创建该类的构造方法的时候要使用 private 修饰，保证外部类不可以使用 new 来创建多个实例。</strong></p>
<p>总结：</p>
<ul>
<li>当单例类构造方法比较简单，逻辑不复杂的时候可以采用（<em>但是并不推荐</em>），一般来说开发的过程中不要使用 饿汉式 来实现单例模式。 </li>
<li>如果类的构造方法复杂，可能会导致类加载很慢。</li>
<li>类加载的时候没有真正的调用，浪费内存资源。</li>
</ul>
<p><br></p>
<h4 id="懒汉式"><a href="#懒汉式" class="headerlink" title="#懒汉式"></a>#懒汉式</h4><p>为了解决 饿汉式 存在的问题，我们可以采用懒汉式的方式来实现单例模式。</p>
<p><strong>方法特点：</strong> 不直接在类中 new 出成员变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleInstance</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> SingleInstance sInstance = <span class="keyword">null</span>;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">SingleInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleInstance <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> == sInstance) &#123;</div><div class="line">          sInstance = <span class="keyword">new</span> SingleInstance();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> sInstance;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法解决掉了之前 饿汉式 的性能问题，但是当处于多个线程的时候我们使用上述代码会出现一个严重的问题。嗯，聚个栗子：</p>
<blockquote>
<p>现在有两个线程分别为 A 线程、B 线程（<em>简称 A 和 B</em>）。 </p>
<p>当 A 执行上面的代码，第一次实例化的时候判断 sInstance 是否为 null，现在为 null 则在 A 中开始创建 SingleInstance 如果创建这个类需要很长的时间,在这个时候 B 线程也执行了上面的代码。B 线程中由于在 A 中的实例还在创建中没有完成，所以 B 中会判断 sInstance 为 null，然后也开始创建实例了。这就导致创建了两个实例，不符合单例模式的设计。</p>
</blockquote>
<p>要解决这个问题就是让 A 在执行上面代码的时候，B 线程不能执行直到 A 执行完成了。这样 B 再执行的时候 sInstance 就不是 null 了，自然也就不会再创建新的实例了。</p>
<p>使用线程锁就可以实现上述过程，所以我们修改代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleInstance</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> SingleInstance sInstance = <span class="keyword">null</span>;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">SingleInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">static</span> SingleInstance <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> == sInstance) &#123;</div><div class="line">          sInstance = <span class="keyword">new</span> SingleInstance();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> sInstance;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>synchronized</code>  是可以保证多线程、单一实例的方法。有了这个线程锁，很多线程都要执行上面代码的时候就必须要排队，一个一个的来。前面的线程没有使用完这个方法，后面来的线程是没有权限执行这个方法的。</p>
<p>ok，一般开发中大家可能都是使用的 懒汉式 这种实现方式。</p>
<p>但是有一个问题。如果多个线程都要执行这块代码，当第一个线程执行完了这块代码创建了实例。后面的线程才能执行代码去获取  <code>synchronized</code>  这个线程锁，注意获取它是一个耗时操作，但是此时实例已经创建了其实已经没有必要再去获取线程锁了。这里就造成了性能低下的问题。</p>
<p>总结：</p>
<ul>
<li>通过使用 <code>synchronized</code>   解决了多线程的问题但是此方式效率并不高，不推荐。</li>
</ul>
<p><br></p>
<h4 id="双重检查锁定方式-double-checked-locking"><a href="#双重检查锁定方式-double-checked-locking" class="headerlink" title="#双重检查锁定方式   double-checked locking"></a>#双重检查锁定方式   double-checked locking</h4><p>由于获取线程锁 <code>synchronized</code>    是一个耗时的操作，要解决 懒汉式 的问题出现了 双重检查锁定的方式。</p>
<p>该方法的思路也很简单，就是如果这个实例由前面的线程创建了的话，后面的线程在执行代码的时候先判断有没有这个实例，如果有了就不去获取线程锁直接返回已经创建好的实例；没有的话才会去创建实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleInstance</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> SingleInstance sInstance = <span class="keyword">null</span>;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">SingleInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleInstance <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> == sInstance) &#123;</div><div class="line">          <span class="keyword">synchronized</span> (SingleInstance.class) &#123;</div><div class="line">              <span class="keyword">if</span> (<span class="keyword">null</span> == sInstance) &#123;</div><div class="line">                  sInstance = <span class="keyword">new</span> SingleInstance();</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> sInstance;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码中可以很清除的看到在  getInstance() 方法中，首先是判断 sInstance 是否为 null 。假设现在 A  和 B  两个线程，现在是 A  先执行上面的代码假设 A 已经创建好了实例，当 B  进入  getInstance() 方法后，先判断实例是否已经存在，此时是存在的所以不需要获取线程锁去创建实例直接返回实例即可。这样后面的线程不需要去获得线程锁大大提高了执行的效率。</p>
<p><strong>可能你会问为什么需要双重检查？</strong></p>
<p>在 Synchronized 中为什么还需要判断实例是否为空呢？我们举个比较特殊的</p>
<blockquote>
<p>同样我们有两个线程 A  和 B。现在我们假设这两个线程同时调用该方法（<em>现在是可以同时调用 getInstance() 方法的，由于没有 synchronized 线程锁</em>）。两个线程同时进入 getInstance() 方法同时在判断实例是否为空，好，此时都判断为空，这个时候假定 A 先获得了线程锁进入方法中去创建实例。当创建完成之后，A 释放，B 获得线程锁进入方法，如果这个时候不判断实例是否存在，则 B  就会创建实例，最终就有了两个实例了。</p>
</blockquote>
<p>ok, 解决了双重检查的问题最最重要的一点还没有提到就是 volatile  这个东西了。</p>
<p>注意在 SingleInstance 类中定义成员变量 sInstance 的时候是用了这个词的。那 volatile 是什么呢？这个具体等下下一篇来说，因为内容较多就不放在这一篇里了，不过你可以去参考一下 <a href="https://www.ibm.com/developerworks/java/library/j-dcl/index.html" target="_blank" rel="external">这里。</a></p>
<p><br></p>
<h4 id="IoDH-方式"><a href="#IoDH-方式" class="headerlink" title="#IoDH 方式"></a>#IoDH 方式</h4><p>饿汉式不能实现延迟加载，不管使用与否都将占用内存；懒汉式线程安全需要去控制线程锁比较麻烦。那么现在还有一种方式来同时有两种方式的优点并且去掉他们的缺陷！它被称为 Initialization Demand Holder（IoDH）方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleInstance</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">SingleInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleInstance <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> SingleInstanceHolder.sInstance;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleInstanceHolder</span> </span>&#123;</div><div class="line">      <span class="keyword">private</span> <span class="keyword">static</span> SingleInstance sInstance = <span class="keyword">new</span> SingleInstance();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在类中创建了一个静态持有类  SingleInstanceHolder 。利用静态类在被加载的时候才会创建的特性，故当 SingleInstance类被加载的时候，如果此时没有加载 SingleInstanceHolder 则该类并不会被加载。这样就能保证在类没有被调用的时候不会占用内存。我们在公有方法中通过该类引用到单例实例。</p>
<p>总结：</p>
<ul>
<li>IoDH 方式综合了了饿汉式 和 懒汉式 两种方式的优点同时也避免了缺陷。</li>
</ul>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p> <a href="https://gof.quanke.name/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html" target="_blank" rel="external">《设计模式 java 版》</a>- sunny</p>
<p><a href="https://www.ibm.com/developerworks/java/library/j-dcl/index.html" target="_blank" rel="external">Double-checked locking and the Singleton pattern</a></p>
<p><a href="http://droidyue.com/blog/2015/01/11/looking-into-singleton/" target="_blank" rel="external">单例这种设计模式</a> - 技术小黑屋</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://jngoogle.github.io/2016/12/29/Retrofit-Rxjava-从入门到跑路（Retrofit）/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Jngoogle">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jngoogle">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jngoogle" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/29/Retrofit-Rxjava-从入门到跑路（Retrofit）/" itemprop="url">
                  Retrofit + Rxjava 从入门到跑路（Retrofit介绍）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-29T14:53:19+08:00">
                2016-12-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Retrofit介绍"><a href="#Retrofit介绍" class="headerlink" title="Retrofit介绍"></a>Retrofit介绍</h1><h3 id="Retrofit是什么"><a href="#Retrofit是什么" class="headerlink" title="Retrofit是什么"></a>Retrofit是什么</h3><p>简单的一句话是一个网络库用来处理一些网络上的数据传输。</p>
<blockquote>
<p>Type-safe HTTP client for Android and Java by Square, Inc.</p>
<p>适用于Android 和 Java 的类型安全的Http 客户端</p>
</blockquote>
<h3 id="如何使用Retrofit"><a href="#如何使用Retrofit" class="headerlink" title="如何使用Retrofit"></a>如何使用Retrofit</h3><h4 id="一-配置-Retrofit"><a href="#一-配置-Retrofit" class="headerlink" title="一  配置 Retrofit"></a>一  配置 Retrofit</h4><p>使用 Gradle 方式添加依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// rxAndroid</span></div><div class="line">compile <span class="string">'io.reactivex:rxandroid:1.0.1'</span></div><div class="line"><span class="comment">// retrofit2</span></div><div class="line">compile <span class="string">'com.squareup.retrofit2:adapter-rxjava:2.0.2'</span></div><div class="line">compile <span class="string">'com.squareup.retrofit2:retrofit:2.0.2'</span></div><div class="line">compile <span class="string">'com.squareup.retrofit2:converter-gson:2.0.2'</span></div><div class="line"><span class="comment">// network interceptor</span></div><div class="line">compile <span class="string">'com.squareup.okhttp3:logging-interceptor:3.1.2'</span></div></pre></td></tr></table></figure>
<p>ps: 注意 converter-gson 是一个转换器，你还可以在以下转换器中选择（本文使用Gson作为例子）：</p>
<ul>
<li><a href="https://github.com/google/gson" target="_blank" rel="external">Gson</a>: <code>com.squareup.retrofit2:converter-gson</code> （google 官方推荐）</li>
<li><a href="http://wiki.fasterxml.com/JacksonHome" target="_blank" rel="external">Jackson</a>: <code>com.squareup.retrofit2:converter-jackson</code></li>
<li><a href="https://github.com/square/moshi/" target="_blank" rel="external">Moshi</a>: <code>com.squareup.retrofit2:converter-moshi</code></li>
<li><a href="https://developers.google.com/protocol-buffers/" target="_blank" rel="external">Protobuf</a>: <code>com.squareup.retrofit2:converter-protobuf</code></li>
<li><a href="https://github.com/square/wire" target="_blank" rel="external">Wire</a>: <code>com.squareup.retrofit2:converter-wire</code></li>
<li><a href="http://simple.sourceforge.net/" target="_blank" rel="external">Simple XML</a>: <code>com.squareup.retrofit2:converter-simplexml</code></li>
<li>Scalars (primitives, boxed, and String): <code>com.squareup.retrofit2:converter-scalars</code></li>
</ul>
<blockquote>
<p>我们还可以在 gradle 中添加 网络拦截器，方便调试。</p>
<p>添加网络调试：<code>compile &#39;com.squareup.okhttp3:logging-interceptor:3.1.2&#39;</code></p>
<p>同时如果要使用 rxjava  rxAndroid 与 retrofit 搭配使用，需要添加以下依赖</p>
<p><code>compile &#39;com.squareup.retrofit2:adapter-rxjava:2.0.2&#39;</code></p>
<p><code>compile &#39;io.reactivex:rxandroid:1.0.1&#39;</code></p>
</blockquote>
<h4 id="二-创建服务"><a href="#二-创建服务" class="headerlink" title="二  创建服务"></a>二  创建服务</h4><p>当你完成了 retrofit 的配置之后，就可以开始创建服务请求了。retrofit 通过接口的方式来提供网络上的请求，下面通过简单的例子来看看如何创建服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMovieTop250</span> </span>&#123;</div><div class="line">    <span class="meta">@GET</span>(<span class="string">"v2/movie/top250?"</span>)</div><div class="line">    Observable&lt;JsonResult&lt;List&lt;Subject&gt;&gt;&gt; getMovie(<span class="meta">@Query</span>(<span class="string">"start"</span>) <span class="keyword">int</span> start,</div><div class="line">                                                   <span class="meta">@Query</span>(<span class="string">"count"</span>) <span class="keyword">int</span> count);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里接上一篇<a href="https://jngoogle.github.io/2016/12/26/Retrofit-RxJava-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%B7%91%E8%B7%AF%EF%BC%88Rxjava%E4%BB%8B%E7%BB%8D%EF%BC%89/">《 Retrofit + Rxjava 从入门到跑路（Rxjava介绍）》</a> 中的json结果，使用的是豆瓣电影的API <a href="https://developers.douban.com/wiki/?title=movie_v2#top250" target="_blank" rel="external">Top250 </a> 的API，Url 请求长这样：<code>https://api.douban.com/v2/movie/top250?start=0;count=1</code></p>
<ul>
<li><p><strong>填写请求地址</strong></p>
<p>我们这样来分解，把 <code>https://api.douban.com/</code> 作为base_url ，剩下的 <code>v2/movie/top250?</code> 作为这个接口请求的url。前面放上 GET 关键字表示请求的方式。base_url 我们将在 serviceManager 中去处理，后面会提到。</p>
<blockquote>
<p>特别提示：base_url 需要以斜杠 / 结尾，否则会报错</p>
</blockquote>
</li>
</ul>
<ul>
<li><p><strong>确定返回类型</strong></p>
<p>写好了请求的地址，我们来写请求返回的参数类型 <code>Observable&lt;JsonResult&lt;List&lt;Subject&gt;&gt;&gt;</code> 表示从 API 返回一个 JsonResult 类型，并且这里使用了 rxjava ，所以是 Observable 而并不是 Call 。</p>
</li>
</ul>
<ul>
<li><p><strong>填写请求参数</strong>（如果需要）</p>
<p>这里我们需要两个参数，采用 Query 关键字，键值对中键的名称分别为 start  和  count 写在括号中，后面写上对应的变量名。</p>
<blockquote>
<p>关于请求的关键字如 GET POST 可以去 <a href="http://square.github.io/retrofit/" target="_blank" rel="external">这里</a> 查看</p>
</blockquote>
</li>
</ul>
<p>这里我们看到一个请求地址就对应着一个接口，当然你可以在一个接口中创建多个请求方法（一般用在同一类型的请求但是各个请求的参数有区别的情况）。这里举一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ISubmitService</span> </span>&#123;</div><div class="line">    <span class="meta">@POST</span>(<span class="string">"confirmOrder?"</span>)</div><div class="line">    <span class="function">Observable&lt;SubmitEntity&gt; <span class="title">submitSaleOrder</span><span class="params">(@Query(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id,</span></div><div class="line">                                             @<span class="title">Query</span><span class="params">(<span class="string">"task_id"</span>)</span> <span class="keyword">int</span> taskId);</div><div class="line"></div><div class="line">    <span class="meta">@POST</span>(<span class="string">"confirmOrder?"</span>)</div><div class="line">    <span class="function">Observable&lt;SubmitEntity&gt; <span class="title">submitRepairOrder</span><span class="params">(@Query(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id,</span></div><div class="line">                                               @<span class="title">Query</span><span class="params">(<span class="string">"task_id"</span>)</span> <span class="keyword">int</span> taskId,</div><div class="line">                                               @<span class="title">Query</span><span class="params">(<span class="string">"order_id"</span>)</span> <span class="keyword">int</span> orderId,</div><div class="line">                                               @<span class="title">Query</span><span class="params">(<span class="string">"order_type"</span>)</span> String orderType);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个请求接口中两个请求方法只是请求的参数不同而已。</p>
<p>完成了以上步骤就创建好了 接口形式的网络请求了。</p>
<h4 id="三-配置你的-ServiceManager"><a href="#三-配置你的-ServiceManager" class="headerlink" title="三  配置你的 ServiceManager"></a>三  配置你的 ServiceManager</h4><p>当你完成了请求接口的创建之后，我们会使用一个 serviceManager 去管理这些众多的接口请求。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceManager</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ServiceManager instance = <span class="keyword">null</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> ServiceManager <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> instance != <span class="keyword">null</span> ? instance : <span class="keyword">new</span> ServiceManager();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">private</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient()</div><div class="line">            .newBuilder()</div><div class="line">            .addInterceptor(<span class="keyword">new</span> HttpLoggingInterceptor()</div><div class="line">                    .setLevel(BuildConfig.DEBUG ?</div><div class="line">                            HttpLoggingInterceptor.Level.BODY : HttpLoggingInterceptor.Level.NONE))</div><div class="line">            .build();</div><div class="line">    <span class="keyword">private</span> Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">            .baseUrl(StrUtil.BASE_URL)</div><div class="line">            .client(client)</div><div class="line">            .addConverterFactory(GsonConverterFactory.create())</div><div class="line">            .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</div><div class="line">            .build();</div><div class="line">    </div><div class="line">     <span class="keyword">private</span> IMovieTop250 iMovieTop250 = retrofit.create(IMovieTop250.class);</div><div class="line">     <span class="function"><span class="keyword">public</span> IMovieTop250 <span class="title">getiMovieTop250</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> iMovieTop250;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简单的说明一下：</p>
<p>首先创建了一个 serviceManager 的单例。然后配置好 OkHttpClient  以及 Retrofit ，相关的注释比较清晰看一下就能明白。</p>
<p>当我们创建好 Retrofit 以后，就可以创建接口服务了使用  <code>retrofit.create(IMovieTop250.class)</code> 创建你的服务。最后向引用类提供一个方法  <code>getiMovieTop250()</code>  来实现请求即可。</p>
<p>至此，所有的请求工作都完成了。下面我们看一下去使用这些服务。</p>
<h4 id="四-使用服务"><a href="#四-使用服务" class="headerlink" title="四  使用服务"></a>四  使用服务</h4><p>首先看一下代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// get movie from api</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getMovie</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">    ServiceManager.getInstance()</div><div class="line">            .getiMovieTop250()</div><div class="line">            .getMovie(start, count)</div><div class="line">            .flatMap(<span class="keyword">new</span> Func1&lt;JsonResult&lt;List&lt;Subject&gt;&gt;, Observable&lt;Subject&gt;&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> Observable&lt;Subject&gt; <span class="title">call</span><span class="params">(JsonResult&lt;List&lt;Subject&gt;&gt; listJsonResult)</span> </span>&#123;</div><div class="line">                    <span class="keyword">return</span> Observable.from(listJsonResult.getSubjects());</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .toList()</div><div class="line">            .subscribeOn(Schedulers.io())</div><div class="line">            .observeOn(AndroidSchedulers.mainThread())</div><div class="line">            .subscribe(<span class="keyword">new</span> Subscriber&lt;List&lt;Subject&gt;&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(List&lt;Subject&gt; subjects)</span> </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (subjects != <span class="keyword">null</span>) &#123;</div><div class="line">                        myAdapter.setDataList(subjects);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> java.net.ConnectException) &#123;</div><div class="line">                        Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"当前网络不可用"</span>,Toast.LENGTH_SHORT).show();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用很简单直接通过 serviceManager 就能使用服务了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ServiceManager.getInstance()</div><div class="line">              .getiMovieTop250()</div><div class="line">              .getMovie(start, count)</div></pre></td></tr></table></figure>
<p>剩下的代码需要去看一下我的关于 Rxjava 介绍的文章 <a href="https://jngoogle.github.io/2016/12/26/Retrofit-RxJava-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%B7%91%E8%B7%AF%EF%BC%88Rxjava%E4%BB%8B%E7%BB%8D%EF%BC%89/">《 Retrofit + Rxjava 从入门到跑路（Rxjava介绍）》</a>。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://jngoogle.github.io/2016/12/26/Retrofit-RxJava-从入门到跑路（Rxjava介绍）/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Jngoogle">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jngoogle">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jngoogle" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/26/Retrofit-RxJava-从入门到跑路（Rxjava介绍）/" itemprop="url">
                  Retrofit + RxJava 从入门到跑路（Rxjava介绍）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-26T14:15:46+08:00">
                2016-12-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>本文较长建议在电脑上阅读(文中除 RxJava + Retrofit 结合运用部分，其余代码示例来自 扔物线 博客)</p>
</blockquote>
<p>2016年也差不多要结束了，作为一个Android小白今年学到的东西回头来看发现还是太少了。给我印象最深的是 MVP设计模式、Retrofit以及RxJava。这篇文章就来讲一下Retrofit和RxJava。</p>
<p>网上有很多这两者相关的资料但是结合起来的文章比较少，本着我们学习的目的是为了真正在工作项目中使用，所以决定写下这篇文章，本人由于工作经验较少文中出现错误了希望大家指出纠正。</p>
<p>这里我要先分开讲两者然后再结合起来，只有分开弄清楚了才能在结合的时候运用自如。</p>
<h1 id="​RxJava"><a href="#​RxJava" class="headerlink" title="​RxJava"></a>​RxJava</h1><p>首先强烈推荐 <a href="https://github.com/rengwuxian" target="_blank" rel="external">扔物线</a> 大大的这篇文章 <a href="http://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="external"> 《给 Android 开发者的 RxJava 详解》</a> 毫不夸张的说，如果真正吃透了这篇文章肯定是能够理解并使用RxJava了（这篇文章较长，系统的介绍了RxJava）。</p>
<p>本人也是看了许多RxJava的文章最终发现了这篇文章才对RxJava形成了一个相对清楚的认识和理解。这里我就用我自己的理解在来梳理一下RxJava。</p>
<h3 id="为什么要用Rxjava，以及什么场景下使用"><a href="#为什么要用Rxjava，以及什么场景下使用" class="headerlink" title="为什么要用Rxjava，以及什么场景下使用"></a>为什么要用Rxjava，以及什么场景下使用</h3><blockquote>
<p>a library for composing asynchronous and event-based programs by using observable sequences.— from Rxjava github</p>
<p>通过使用可观察序列来组成异步和基于事件的程序的库。</p>
</blockquote>
<p>异步 + 简洁  是Rxjava的关键词 。</p>
<ul>
<li>在需要处理异步的场景下使用：Rxjava的本质还是为了处理异步这件事。</li>
<li>因为Rxjava处理逻辑的十分简洁 ，采用了链式的组织方式使得方便拼接来处理复杂的逻辑。</li>
</ul>
<h3 id="介绍观察者模式"><a href="#介绍观察者模式" class="headerlink" title="介绍观察者模式"></a>介绍观察者模式</h3><p>因为Rxjava在处理异步问题的时候采用的是 观察者模式。我们首先来熟悉一下观察者模式。其实对于Android日常开发中我们已经非常熟练的去使用了观察者模式了。我们都使用过Button，写过Button的点击事件。</p>
<ul>
<li><strong>名词解释</strong>（熟悉自行跳过直接看 <code>代码实现</code> ）</li>
</ul>
<p>所谓的 观察者模式 也可以称为 注册-订阅模式，就拿当下十分流行的直播来类比一下。比如我很喜欢B站的一位阿婆主（咦，好像暴露了什么）。她的每次直播我都想看，假设阿婆主直播的时间不是固定的，那我很有可能错过直播那我应该怎么做才能解决这个问题呢？</p>
<p>两种方式：</p>
<ol>
<li>阿婆主每次直播的时候自己主动通知我（我觉得只有可能我在阿婆主的粉丝群里或者就我一个观众 233才可能这样）</li>
<li>我在B站上关注了阿婆主。注意噢，这里的关注就是意味着订阅了，也就是说只要阿婆主有直播我就能收到通知。</li>
</ol>
<p>至此我想你应该懂了什么叫 注册-订阅（观察者）模式了，就是说只要我订阅了某个事件源（阿婆主开直播），当事件发生时我就能收到通知。好，我们接下来用一张表来更加清晰的看看这个模式的各个部分组成。</p>
<table>
<thead>
<tr>
<th>观察者（事件处理者）</th>
<th style="text-align:left">被观察者（搞事者）</th>
<th style="text-align:left">订阅</th>
</tr>
</thead>
<tbody>
<tr>
<td>我</td>
<td style="text-align:left">阿婆主</td>
<td style="text-align:left">关注阿婆主这个动作</td>
</tr>
</tbody>
</table>
<p>现在的直播都是采用观察者模式的，好处就是在于无论阿婆主有多少粉丝只要你关注（订阅）了阿婆主，当阿婆主开直播了，这个事件消息能够发送给所有订阅了的粉丝。也就是不需要阿婆主每一个人去挨个通知了。</p>
<p>我们现在再回到开头的提到的Button的这个事情。我们换一种说法可以把观察者模式理解成为监听模式。关注阿婆主之后就好像放置了一个监听器一直在监听阿婆主是否开播这个事件。一旦阿婆主开播事件被触发监听器就启动，然后执行相应的处理（观看直播 or 给阿婆主刷刷礼物）。</p>
<p>所以看到这里写Android的小伙伴是不是觉得监听器有点熟悉，这个在Button上监听它被点击了的监听器不就是OnClickListener吗？当Button（被观察者 or 事件源）被点击之后，OnClickListener（观察者 or 事件处理者）就开始执行相应的操作，可能是跳转Activity也可能是弹出dialog等等。那这个监听器是在哪里订阅或者说关注了Button的一举一动的呢？当然就是在你经常写的 <code>btn.setOnClickListener()</code>的时候啦。在这个时候Button已经被OnClickListener所关注了。</p>
<table>
<thead>
<tr>
<th style="text-align:left">Observer  观察者（事件处理者）</th>
<th>Observable  被观察者（搞事者）</th>
<th>Subscribe  订阅</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">我</td>
<td>阿婆主</td>
<td>关注阿婆主这个动作</td>
</tr>
<tr>
<td style="text-align:left">OnClickListener   监听器</td>
<td>Button   按钮</td>
<td>setOnClickListener   绑定监听</td>
</tr>
</tbody>
</table>
<p>好的，啰嗦了这么多我为什么要介绍这个观察者模式呢？ 是因为我们Rxjava就是要处理异步问题的，异步一般来说那个不在主线程中的任务会比较耗时，为了防止ANR就会用到观察者模式。观察者不用时时刻刻去查看是否需要更新View了（如果那样好累的说）只要我关注了我需要关注的事件源（比如Button的点击事件）就可以在发生了特定事件的时候获得消息然后再更新View。</p>
<ul>
<li><p><strong>代码实现</strong>.</p>
<p><strong>0 如何引入Rxjava</strong></p>
<p>Example for Gradle:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// in your modules' build.gradle</span></div><div class="line">   <span class="comment">// Rxjava</span></div><div class="line">   compile <span class="string">'com.squareup.retrofit2:adapter-rxjava:2.0.2'</span></div><div class="line">   <span class="comment">// RXandroid</span></div><div class="line">   compile <span class="string">'io.reactivex:rxandroid:1.0.1'</span></div></pre></td></tr></table></figure>
<p><strong>1 创建观察者（事件处理者）Observer</strong><br>观察者决定了当事件被触发了做出怎样的回应（在onNext 方法中处理）。  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Observer&lt;String&gt; observer = <span class="keyword">new</span> Observer&lt;String&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Item: "</span> + s);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Completed!"</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Error!"</span>);</div><div class="line">    &#125;&#125;;</div></pre></td></tr></table></figure>
<p>​</p>
<p>首先说明我们在实际的开发中一般创建观察者的时候使用的并不是Observer而是Subscriber。<br>Observer正如其字面的意思就是观察者，是一个接口里面的接口方法就是上面的三个方法，onNext()  onCompleted()  onError() 。而在实际开发中使用到的Subscriber是什么呢？<br>通过查看源码 public abstract class Subscriber<t> implements Observer<t>, Subscription ，原来Subscriber是一个抽象类它实现了 Observer 和 Sbuscription 这两个接口。</t></t></p>
<ul>
<li>Observer  — onNext()   onCompleted()  onError()</li>
<li>subscription — unsubscribe()  isUnsubscribed()</li>
</ul>
</li>
</ul>
<p>其实Subscriber的用法跟Observer用法基本一致，相比于Observer多了一些重写方法,从表格中可以看出多了<code>unsubscribe()</code> 和 <code>isUnsubscribed()</code> 这两个方法。</p>
<blockquote>
<p>新增的这两个接口方法有着重要的意义，<code>unsubscribe()</code> 用于取消订阅。恩，既然我可以关注一个阿婆主当然也能够取消关注嘛。这个方法一般是在 onStop() 或者 onPause() 中去实现，取消订阅释放内存防止内存泄漏。阿婆主我取消对你关注了你不可能还死皮赖脸的缠着不放吧 233 。</p>
</blockquote>
<p>下面是 subscribe的创建（其实基本都是一样的）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;String&gt;() &#123;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Item: "</span> + s);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Completed!"</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        Log.d(tag, <span class="string">"Error!"</span>);</div><div class="line">    &#125;&#125;;</div></pre></td></tr></table></figure>
<p><strong>2 创建被观察者（搞事者）Observable</strong></p>
<p>Observable决定了发送什么事件以及何时发送时间即 what &amp; when。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Observable observable = Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;String&gt;() &#123;</div><div class="line">    </div><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> String&gt; subscriber)</span> </span>&#123;</div><div class="line">        subscriber.onNext(<span class="string">"Hello"</span>);</div><div class="line">        subscriber.onNext(<span class="string">"World"</span>);</div><div class="line">        subscriber.onCompleted();</div><div class="line">    &#125;&#125;);</div></pre></td></tr></table></figure>
<p>我们从上面的简单例子可以看到不管是观察者还是被观察者处理的数据类型都是基本的String类型。在真实的项目开发中，我们在使用Rxjava + Retrofit 的时候要处理的类型往往是通过服务器给定的，通常事先是不知道的。这就需要我们在类型的地方使用泛型来处理，这里只是简单的示例。</p>
<blockquote>
<p>除了可以使用 create来创建一个被观察者还可以使用just 和 from， 而这些都被称作操作符，大家可以去<a href="https://mcxiaoke.gitbooks.io/rxdocs/content/Operators.html" target="_blank" rel="external">这里</a> 了解一下。</p>
</blockquote>
<p><strong>3 订阅Subscribe</strong></p>
<p>只要在 Observable中订阅一下，将Observe与其连接起来就是完成订阅了。</p>
<p>举例说明一下：</p>
<p>由指定的一个 drawable 文件 id drawableRes 取得图片，并显示在 ImageView 中，并在出现异常的时候打印 Toast 报错：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> drawableRes = ...;</div><div class="line">ImageView imageView = ...;</div><div class="line">Observable.create(<span class="keyword">new</span> OnSubscribe&lt;Drawable&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Drawable&gt; subscriber)</span> </span>&#123;</div><div class="line">        Drawable drawable = getTheme().getDrawable(drawableRes));</div><div class="line">        subscriber.onNext(drawable);</div><div class="line">        subscriber.onCompleted();</div><div class="line">    &#125;</div><div class="line">&#125;).subscribe(<span class="keyword">new</span> Observer&lt;Drawable&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Drawable drawable)</span> </span>&#123;</div><div class="line">        imageView.setImageDrawable(drawable);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">        Toast.makeText(activity, <span class="string">"Error!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>好，至此我们已经看到了整个观察者模式一个完整的流程了即创建 Observable 和 Observe 然后通过 Subscribe 连接两者即可。</p>
<h3 id="真正的使用Rxjava"><a href="#真正的使用Rxjava" class="headerlink" title="真正的使用Rxjava"></a>真正的使用Rxjava</h3><p>在上面一节 介绍观察者模式中我们提出来完整的流程，我们也就基本的了解了Rxjava的工作流程，但是这不是Rxjava真正的使用方式！</p>
<p>因为我们使用Rxjava的最初目的还是处理 异步问题。而目前为止所看到的所有代码都是在同一个线程中执行的，所以并不是Rxjava真正的使用方式。接下来，我们就要在不同的线程之间去使用Rxjava。</p>
<p>为了在不同的线程中去使用Rxjava这就表明我们需要线程切换。我在A线程做一件事情，然后切换到B线程去做另外一件事情。刚好Rxjava提供了调度器，它可以用来切换线程。在Rxjava中使用Schedulars — 调度器来切换线程。该调度器已经默认提供了一些线程可供我们使用。</p>
<table>
<thead>
<tr>
<th style="text-align:left">方法名</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">immediate()</td>
<td style="text-align:left">在当前线程中执行(缺省模式)</td>
</tr>
<tr>
<td style="text-align:left">computation()</td>
<td style="text-align:left">计算所使用的 Scheduler。这个计算指的是 CPU 密集型计算，即不会被 I/O 等操作限制性能的操作，例如图形的计算。这个 Scheduler 使用的固定的线程池，大小为 CPU 核数。不要把 I/O 操作放在 computation() 中，否则 I/O 操作的等待时间会浪费 CPU。</td>
</tr>
<tr>
<td style="text-align:left">io()</td>
<td style="text-align:left">I/O 操作（读写文件、读写数据库、网络信息交互等）所使用的 Scheduler。行为模式和 newThread() 差不多，区别在于 io() 的内部实现是是用一个无数量上限的线程池，可以重用空闲的线程，因此多数情况下 io() 比 newThread() 更有效率。不要把计算工作放在 io() 中，可以避免创建不必要的线程</td>
</tr>
<tr>
<td style="text-align:left">newThread()</td>
<td style="text-align:left">总是创建新的线程，并在新的线程中执行</td>
</tr>
<tr>
<td style="text-align:left">mainThread()</td>
<td style="text-align:left">Android中的主线程</td>
</tr>
</tbody>
</table>
<p>一般在实际的项目中用到最多的就是 io  newThread 以及 mainThread 这三个线程。在被观察者中 Observable提供了 两个方式分别是 <code>subscribeOn()</code>  和 <code>observeOn()</code>  来指定观察者和被观察者分别运行在哪个线程。</p>
<p>举例说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ServiceManager.getInstance()</div><div class="line">                        .getMovieService()</div><div class="line">                        .getMovie(<span class="number">0</span>, <span class="number">10</span>)</div><div class="line">                        .subscribeOn(Schedulers.newThread())</div><div class="line">                        .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                        .subscribe(<span class="keyword">new</span> MySubscriber&lt;ApiResult&lt;Subject&gt;&gt;(context) &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(ApiResult&lt;Subject&gt; subjectApiResult)</span> </span>&#123;</div><div class="line">                                <span class="comment">// do something</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div></pre></td></tr></table></figure>
<p>从这个例子上我们可以看到  观察者是运行在新的线程上而  被观察者则是运行在主线程上。注意看在subscribeOn() 的前一句是获取电影的相关信息  getMovie()， 而获取这个信息需要的时间可能较长且不确定所以放在了另外一个新的线程中去执行你可以说实在后台线程执行。最后得到数据之后在再主线程中进行相应的处理。（这里已经是使用了Rxjava + Retrofit）</p>
<h3 id="Rxjava是如此的灵活"><a href="#Rxjava是如此的灵活" class="headerlink" title="Rxjava是如此的灵活"></a>Rxjava是如此的灵活</h3><p>如果你能看到这里非常感谢，以上的内容都是介绍和解释了Rxjava 是如何处理异步问题。还记得文章最开头提到的Rxjava的两个关键词吗？ 异步 +  简洁， 这一节就要介绍Rxjava为什么相比于其他处理异步问题的方式为什么简洁、灵活。</p>
<p>我们先来说说什么样的逻辑是容易被理解的。我个人认为直的逻辑，换句话说不需要考虑各种分支各种例外情况或者是多层关系的逻辑是容易被理解的（层级、依赖、分支较少的逻辑我认为就是直的逻辑）。好比路线，一条直路就能到达目的地当时给人的感觉是清晰、简单的。恰好，Rxjava就是这种链式的一条直的逻辑。依靠着众多 操作符 能够非常方便的实现拼积木的感觉（多了直接扔掉，少了直接加上就好不用考虑依赖、层级之间的关系）。</p>
<p>举例演示一下（注意这里Rxjava和Retrofit结合在使用）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">ServiceManager.getInstance()</div><div class="line">                        .getMovieService()</div><div class="line">                        .getMovie(<span class="number">0</span>, <span class="number">10</span>)</div><div class="line">                        .flatMap(<span class="keyword">new</span> Func1&lt;ApiResult&lt;Subject&gt;, Observable&lt;Subject&gt;&gt;() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> Observable&lt;Subject&gt; <span class="title">call</span><span class="params">(ApiResult&lt;Subject&gt; subjectApiResult)</span> </span>&#123;</div><div class="line">                                <span class="keyword">return</span> Observable.from(subjectApiResult.getSubjects());</div><div class="line">                            &#125;</div><div class="line">                        &#125;)</div><div class="line">                        .map(<span class="keyword">new</span> Func1&lt;Subject, String&gt;() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">(Subject subject)</span> </span>&#123;</div><div class="line">                                <span class="keyword">return</span> subject.getTitle();</div><div class="line">                            &#125;</div><div class="line">                        &#125;)</div><div class="line">                        .subscribeOn(Schedulers.io())</div><div class="line">                        .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                        .subscribe(<span class="keyword">new</span> MySubscriber&lt;String&gt;(context) &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">                                apiResultTv.setText(s);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div></pre></td></tr></table></figure>
<p>ok,对于刚刚接触Rxjava的人可能一下子会觉得真正使用Rxjava是这么的麻烦，看着代码好像很多逻辑反而不清晰呢。其实这只是由于新接触Rxjava被表面的代码书写格式所吓到了而已。下面来分析一下这一串代码，首先介绍一下背景：</p>
<p>我通过豆瓣电影API得到电影Top250 的相关信息，然后在手机上显示出来更新UI。</p>
<blockquote>
<p>豆瓣电影API可以在 <a href="https://developers.douban.com/wiki/?title=movie_v2" target="_blank" rel="external">这里查看</a> ，此处代码使用的是 榜单 <a href="https://developers.douban.com/wiki/?title=movie_v2#top250" target="_blank" rel="external">Top250</a> 这个接口(json返回结果较复杂请耐心分析)。在chrome浏览器中下载 postman 然后输入 <a href="https://api.douban.com/v2/movie/top250?start=0&amp;count=10" target="_blank" rel="external">https://api.douban.com/v2/movie/top250?start=0&amp;count=10</a> 查看json返回结果。</p>
</blockquote>
<p>我们来分析代码，首先通过getMovie() 得到了API所返回的json结果。这里根据提供的json结果返回的格式是</p>
<p>Observable &lt; ApiResult&lt; Subject&gt;&gt; 是一个被观察者Observable （这里真实的场景就是我们通过网络就得到了被观察者而不是自己去创建），然后我们开始多次使用操作符来对这个最原始的 json返回结果进行剥离只留下我们需要的数据，比如这里我只需要榜单中电影的名字。</p>
<p>第一次我们使用了 flatmap 得到了subject ， 然后我们再使用了 map 得到了String 这个对应着电影的名字。此时被观察者所发出的事件中的数据由 Observable &lt; ApiResult&lt; Subject&gt;&gt; 变成了 String 。至此被观察者的事情就处理好了事件源返回了我们想要的那一部分的数据。接下来分别使用 subscribeOn 和 observeOn 来分别指定这些任务应该运行在哪个线程。显然我们指定了观察者的任务处理在 io 线程， 被观察者是运行在主线程中的。最后的最后，我们进行了关注 - 订阅 告诉观察者如果你收到了被观察者的事件通知应该做点什么（setText 更新了UI）。</p>
<p>好，如果你再结合上lambda 表达式的话，代码会看起来更清爽（但是个人不推荐）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ServiceManager.getInstance()</div><div class="line">                        .getMovieService()</div><div class="line">                        .getMovie(<span class="number">0</span>, <span class="number">10</span>)</div><div class="line">                        .flatMap(subjectApiResult -&gt; Observable.from(subjectApiResult.getSubjects()))</div><div class="line">                        .map(subject -&gt; subject.getTitle())</div><div class="line">                        .subscribeOn(Schedulers.io())</div><div class="line">                        .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                        .subscribe(<span class="keyword">new</span> MySubscriber&lt;String&gt;(context) &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">                                apiResultTv.setText(s);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div></pre></td></tr></table></figure>
<p>总结一下：其实整个这一串代码就是链式下来的一个直的逻辑。</p>
<ul>
<li>得到API返回结果                  getMovie()</li>
<li>转化得到的结果为Subject   flatMap()</li>
<li>转化得到的结果为String      map()</li>
<li>指定线程                                observeOn()  subscribeOn()</li>
<li>订阅                                        subscribe()</li>
</ul>
<p>Rxjava 之所以说它灵活是因为在转化的过程中你想怎么转化都是可以的，它可以通过多种操作符来适应你的各种筛选要求。之后会用一篇文章介绍一下常用的一些操作符。</p>
<hr>
<h3 id="​后记"><a href="#​后记" class="headerlink" title="​后记"></a>​后记</h3><p>终于告一段落了，Rxjava 的基本介绍就这么多了，希望这边文章能给你们一点点帮助。本文中除了 Rxjava 与 Retrofit结合的代码是原创，剩下的示例代码来自 扔物线。还有如果想了解一下 lambda 表达式的同学可以去 <a href="https://loshine.me/2016/03/30/use-lambda-in-android/" target="_blank" rel="external">这里学习</a></p>
<h3 id="特别感谢"><a href="#特别感谢" class="headerlink" title="特别感谢"></a>特别感谢</h3><ul>
<li><p><a href="https://loshine.me/" target="_blank" rel="external">饭窝</a></p>
</li>
<li><p><a href="https://github.com/rengwuxian" target="_blank" rel="external">扔物线</a></p>
<p>​</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Jngoogle" />
          <p class="site-author-name" itemprop="name">Jngoogle</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jngoogle</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


</body>
</html>
