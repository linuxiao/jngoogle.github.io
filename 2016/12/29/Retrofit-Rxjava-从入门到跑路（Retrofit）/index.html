<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="yanm1ng&#39;s blog">
  <meta name="keyword" content="hexo-theme, vuejs">
  <title>
    
      Retrofit + Rxjava 从入门到跑路（Retrofit介绍） | Jngoogle
    
  </title>
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/plugins/gitment.css">
  <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdn.bootcss.com/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>
  <script src="/js/qrious.js"></script>
  <script src="/js/gitment.js"></script>
</head>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Jngoogle</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>Retrofit + Rxjava 从入门到跑路（Retrofit介绍）</h2>
  <p class="post-date">2016-12-29</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body">
  <article class="post-article">
    <section class="markdown-content"><h1 id="Retrofit介绍"><a href="#Retrofit介绍" class="headerlink" title="Retrofit介绍"></a>Retrofit介绍</h1><h3 id="Retrofit是什么"><a href="#Retrofit是什么" class="headerlink" title="Retrofit是什么"></a>Retrofit是什么</h3><p>简单的一句话是一个网络库用来处理一些网络上的数据传输。</p>
<blockquote>
<p>Type-safe HTTP client for Android and Java by Square, Inc.</p>
<p>适用于Android 和 Java 的类型安全的Http 客户端</p>
</blockquote>
<h3 id="如何使用Retrofit"><a href="#如何使用Retrofit" class="headerlink" title="如何使用Retrofit"></a>如何使用Retrofit</h3><h4 id="一-配置-Retrofit"><a href="#一-配置-Retrofit" class="headerlink" title="一  配置 Retrofit"></a>一  配置 Retrofit</h4><p>使用 Gradle 方式添加依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// rxAndroid</span></div><div class="line">compile <span class="string">'io.reactivex:rxandroid:1.0.1'</span></div><div class="line"><span class="comment">// retrofit2</span></div><div class="line">compile <span class="string">'com.squareup.retrofit2:adapter-rxjava:2.0.2'</span></div><div class="line">compile <span class="string">'com.squareup.retrofit2:retrofit:2.0.2'</span></div><div class="line">compile <span class="string">'com.squareup.retrofit2:converter-gson:2.0.2'</span></div><div class="line"><span class="comment">// network interceptor</span></div><div class="line">compile <span class="string">'com.squareup.okhttp3:logging-interceptor:3.1.2'</span></div></pre></td></tr></table></figure>
<p>ps: 注意 converter-gson 是一个转换器，你还可以在以下转换器中选择（本文使用Gson作为例子）：</p>
<ul>
<li><a href="https://github.com/google/gson" target="_blank" rel="external">Gson</a>: <code>com.squareup.retrofit2:converter-gson</code> （google 官方推荐）</li>
<li><a href="http://wiki.fasterxml.com/JacksonHome" target="_blank" rel="external">Jackson</a>: <code>com.squareup.retrofit2:converter-jackson</code></li>
<li><a href="https://github.com/square/moshi/" target="_blank" rel="external">Moshi</a>: <code>com.squareup.retrofit2:converter-moshi</code></li>
<li><a href="https://developers.google.com/protocol-buffers/" target="_blank" rel="external">Protobuf</a>: <code>com.squareup.retrofit2:converter-protobuf</code></li>
<li><a href="https://github.com/square/wire" target="_blank" rel="external">Wire</a>: <code>com.squareup.retrofit2:converter-wire</code></li>
<li><a href="http://simple.sourceforge.net/" target="_blank" rel="external">Simple XML</a>: <code>com.squareup.retrofit2:converter-simplexml</code></li>
<li>Scalars (primitives, boxed, and String): <code>com.squareup.retrofit2:converter-scalars</code></li>
</ul>
<blockquote>
<p>我们还可以在 gradle 中添加 网络拦截器，方便调试。</p>
<p>添加网络调试：<code>compile &#39;com.squareup.okhttp3:logging-interceptor:3.1.2&#39;</code></p>
<p>同时如果要使用 rxjava  rxAndroid 与 retrofit 搭配使用，需要添加以下依赖</p>
<p><code>compile &#39;com.squareup.retrofit2:adapter-rxjava:2.0.2&#39;</code></p>
<p><code>compile &#39;io.reactivex:rxandroid:1.0.1&#39;</code></p>
</blockquote>
<h4 id="二-创建服务"><a href="#二-创建服务" class="headerlink" title="二  创建服务"></a>二  创建服务</h4><p>当你完成了 retrofit 的配置之后，就可以开始创建服务请求了。retrofit 通过接口的方式来提供网络上的请求，下面通过简单的例子来看看如何创建服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMovieTop250</span> </span>&#123;</div><div class="line">    <span class="meta">@GET</span>(<span class="string">"v2/movie/top250?"</span>)</div><div class="line">    Observable&lt;JsonResult&lt;List&lt;Subject&gt;&gt;&gt; getMovie(<span class="meta">@Query</span>(<span class="string">"start"</span>) <span class="keyword">int</span> start,</div><div class="line">                                                   <span class="meta">@Query</span>(<span class="string">"count"</span>) <span class="keyword">int</span> count);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里接上一篇<a href="https://jngoogle.github.io/2016/12/26/Retrofit-RxJava-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%B7%91%E8%B7%AF%EF%BC%88Rxjava%E4%BB%8B%E7%BB%8D%EF%BC%89/">《 Retrofit + Rxjava 从入门到跑路（Rxjava介绍）》</a> 中的json结果，使用的是豆瓣电影的API <a href="https://developers.douban.com/wiki/?title=movie_v2#top250" target="_blank" rel="external">Top250 </a> 的API，Url 请求长这样：<code>https://api.douban.com/v2/movie/top250?start=0;count=1</code></p>
<ul>
<li><p><strong>填写请求地址</strong></p>
<p>我们这样来分解，把 <code>https://api.douban.com/</code> 作为base_url ，剩下的 <code>v2/movie/top250?</code> 作为这个接口请求的url。前面放上 GET 关键字表示请求的方式。base_url 我们将在 serviceManager 中去处理，后面会提到。</p>
<blockquote>
<p>特别提示：base_url 需要以斜杠 / 结尾，否则会报错</p>
</blockquote>
</li>
</ul>
<ul>
<li><p><strong>确定返回类型</strong></p>
<p>写好了请求的地址，我们来写请求返回的参数类型 <code>Observable&lt;JsonResult&lt;List&lt;Subject&gt;&gt;&gt;</code> 表示从 API 返回一个 JsonResult 类型，并且这里使用了 rxjava ，所以是 Observable 而并不是 Call 。</p>
</li>
</ul>
<ul>
<li><p><strong>填写请求参数</strong>（如果需要）</p>
<p>这里我们需要两个参数，采用 Query 关键字，键值对中键的名称分别为 start  和  count 写在括号中，后面写上对应的变量名。</p>
<blockquote>
<p>关于请求的关键字如 GET POST 可以去 <a href="http://square.github.io/retrofit/" target="_blank" rel="external">这里</a> 查看</p>
</blockquote>
</li>
</ul>
<p>这里我们看到一个请求地址就对应着一个接口，当然你可以在一个接口中创建多个请求方法（一般用在同一类型的请求但是各个请求的参数有区别的情况）。这里举一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ISubmitService</span> </span>&#123;</div><div class="line">    <span class="meta">@POST</span>(<span class="string">"confirmOrder?"</span>)</div><div class="line">    <span class="function">Observable&lt;SubmitEntity&gt; <span class="title">submitSaleOrder</span><span class="params">(@Query(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id,</span></div><div class="line">                                             @<span class="title">Query</span><span class="params">(<span class="string">"task_id"</span>)</span> <span class="keyword">int</span> taskId);</div><div class="line"></div><div class="line">    <span class="meta">@POST</span>(<span class="string">"confirmOrder?"</span>)</div><div class="line">    <span class="function">Observable&lt;SubmitEntity&gt; <span class="title">submitRepairOrder</span><span class="params">(@Query(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id,</span></div><div class="line">                                               @<span class="title">Query</span><span class="params">(<span class="string">"task_id"</span>)</span> <span class="keyword">int</span> taskId,</div><div class="line">                                               @<span class="title">Query</span><span class="params">(<span class="string">"order_id"</span>)</span> <span class="keyword">int</span> orderId,</div><div class="line">                                               @<span class="title">Query</span><span class="params">(<span class="string">"order_type"</span>)</span> String orderType);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个请求接口中两个请求方法只是请求的参数不同而已。</p>
<p>完成了以上步骤就创建好了 接口形式的网络请求了。</p>
<h4 id="三-配置你的-ServiceManager"><a href="#三-配置你的-ServiceManager" class="headerlink" title="三  配置你的 ServiceManager"></a>三  配置你的 ServiceManager</h4><p>当你完成了请求接口的创建之后，我们会使用一个 serviceManager 去管理这些众多的接口请求。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceManager</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ServiceManager instance = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> ServiceManager <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> instance != <span class="keyword">null</span> ? instance : <span class="keyword">new</span> ServiceManager();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient()</div><div class="line">            .newBuilder()</div><div class="line">            .addInterceptor(<span class="keyword">new</span> HttpLoggingInterceptor()</div><div class="line">                    .setLevel(BuildConfig.DEBUG ?</div><div class="line">                            HttpLoggingInterceptor.Level.BODY : HttpLoggingInterceptor.Level.NONE))</div><div class="line">            .build();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">            .baseUrl(StrUtil.BASE_URL)</div><div class="line">            .client(client)</div><div class="line">            .addConverterFactory(GsonConverterFactory.create())<span class="comment">// use gson converter</span></div><div class="line">            .addCallAdapterFactory(RxJavaCallAdapterFactory.create())<span class="comment">// use rxjava</span></div><div class="line">            .build();</div><div class="line"></div><div class="line">    <span class="comment">// create service</span></div><div class="line">    <span class="keyword">private</span> IMovieTop250 iMovieTop250 = retrofit.create(IMovieTop250.class);</div><div class="line"></div><div class="line">    <span class="comment">// public method</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IMovieTop250 <span class="title">getiMovieTop250</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> iMovieTop250;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简单的说明一下：</p>
<p>首先创建了一个 serviceManager 的单例。然后配置好 OkHttpClient  以及 Retrofit ，相关的注释比较清晰看一下就能明白。</p>
<p>当我们创建好 Retrofit 以后，就可以创建接口服务了使用  <code>retrofit.create(IMovieTop250.class)</code> 创建你的服务。最后向引用类提供一个方法  <code>getiMovieTop250()</code>  来实现请求即可。</p>
<p>至此，所有的请求工作都完成了。下面我们看一下去使用这些服务。</p>
<h4 id="四-使用服务"><a href="#四-使用服务" class="headerlink" title="四  使用服务"></a>四  使用服务</h4><p>首先看一下代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// get movie from api</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getMovie</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">    ServiceManager.getInstance()</div><div class="line">            .getiMovieTop250()</div><div class="line">            .getMovie(start, count)</div><div class="line">            .flatMap(<span class="keyword">new</span> Func1&lt;JsonResult&lt;List&lt;Subject&gt;&gt;, Observable&lt;Subject&gt;&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> Observable&lt;Subject&gt; <span class="title">call</span><span class="params">(JsonResult&lt;List&lt;Subject&gt;&gt; listJsonResult)</span> </span>&#123;</div><div class="line">                    <span class="keyword">return</span> Observable.from(listJsonResult.getSubjects());</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">            .toList()</div><div class="line">            .subscribeOn(Schedulers.io())</div><div class="line">            .observeOn(AndroidSchedulers.mainThread())</div><div class="line">            .subscribe(<span class="keyword">new</span> Subscriber&lt;List&lt;Subject&gt;&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(List&lt;Subject&gt; subjects)</span> </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (subjects != <span class="keyword">null</span>) &#123;</div><div class="line">                        myAdapter.setDataList(subjects);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> java.net.ConnectException) &#123;</div><div class="line">                        Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"当前网络不可用"</span>,Toast.LENGTH_SHORT).show();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用很简单直接通过 serviceManager 就能使用服务了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ServiceManager.getInstance()</div><div class="line">              .getiMovieTop250()</div><div class="line">              .getMovie(start, count)</div></pre></td></tr></table></figure>
<p>剩下的代码需要去看一下我的关于 Rxjava 介绍的文章 <a href="https://jngoogle.github.io/2016/12/26/Retrofit-RxJava-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E8%B7%91%E8%B7%AF%EF%BC%88Rxjava%E4%BB%8B%E7%BB%8D%EF%BC%89/">《 Retrofit + Rxjava 从入门到跑路（Rxjava介绍）》</a>。</p>
</section>
    
      <div class="tags">
        <span>Tags:</span>
        
  <span class="tag-code">Android</span>

      </div>
    
    <div class="money-like">
      <div class="reward-btn">
        赏
        <span class="money-code">
          <span class="alipay-code">
            <div class="code-image"></div>
            <b>使用支付宝打赏</b>
          </span>
          <span class="wechat-code">
            <div class="code-image"></div>
            <b>使用微信打赏</b>
          </span>
        </span>
      </div>
      <p class="notice">若你觉得我的文章对你有帮助，欢迎点击上方按钮对我打赏</p>
    </div>
    <div class="qrcode">
      <canvas id="share-qrcode"></canvas>
      <p class="notice">扫描二维码，分享此文章</p>
    </div>
    <div id="comments"></div>
  </article>
</main>

<script>
  (function () {
    var url = 'https://jngoogle.github.io/2016/12/29/Retrofit-Rxjava-从入门到跑路（Retrofit）/';
    $('#article-banner').geopattern(url)
    $('.header').removeClass('fixed-header')

     // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://yanm1ng.cn/error-img.png') 
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

    // gitment
    var gitmentConfig = "jngoogle";
    if (gitmentConfig != "undefined") {
      var gitment = new Gitment({
        owner: "jngoogle",
        repo: "jngoogle.github.io",
        oauth: {
          client_id: "a7daaa9ef8e1113741c6",
          client_secret: "fed19c22a2cd3f1ee7f737a42d5cb2630114d1ba"
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "en-US"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2017 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>
<script>
  var hasLine = 'true';
  async("//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine == 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->

<script src="/js/script.js"></script>
  </body>
</html>